<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Shotclock</title>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a2a;
      --accent:#ffcc00;
      --danger:#ff3b30;
      --text:#e7eefc;
      --muted:#93a4c7;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    body{
      margin:0;
      background:linear-gradient(180deg,#060a12, #0b0f17 40%, #060a12);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      touch-action: manipulation;
    }
    .app{
      width:min(920px, 100%);
      background:rgba(18,26,42,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    #err{
      display:none;
      padding:10px 12px;
      background:rgba(255,59,48,.18);
      border-bottom:1px solid rgba(255,59,48,.35);
      color:#ffd1ce;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; background:rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    header h1{font-size:14px;margin:0;letter-spacing:.8px;color:var(--muted);font-weight:900;}
    header .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .kbd{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px;
      background:rgba(0,0,0,.18); user-select:none;
    }
    main{padding:16px 14px 14px;}
    .displayWrap{
      background:radial-gradient(1200px 520px at 50% 30%, rgba(255,204,0,.16), transparent 55%),
                 rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:18px 14px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; min-height: 240px;
    }
    .time{
      font-variant-numeric:tabular-nums;
      font-size: clamp(96px, 18vw, 220px);
      line-height:1; font-weight:900; letter-spacing:2px;
      color:var(--accent);
      text-shadow:0 10px 40px rgba(255,204,0,.18);
      user-select:none;
      min-height: 1em;
    }
    .time.danger{ color:var(--danger); text-shadow:0 10px 40px rgba(255,59,48,.18); }
    .sub{
      color:var(--muted); font-size:13px; display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      justify-content:center; user-select:none;
    }
    .grid{
      display:grid; grid-template-columns: 1.4fr .6fr; gap:14px; margin-top:14px;
    }
    @media (max-width:760px){ .grid{grid-template-columns:1fr; } }
    .card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    button{
      appearance:none; border:0; cursor:pointer;
      padding:14px 16px; border-radius:16px;
      background:rgba(255,255,255,.08);
      color:var(--text); font-weight:900;
      border:1px solid rgba(255,255,255,.10);
      transition:transform .05s ease, background .12s ease;
      min-width:140px;
    }
    button:active{ transform:scale(.98); }
    button.primary{ background:rgba(255,204,0,.18); border-color:rgba(255,204,0,.35); color:#fff1b3;}
    button.danger{ background:rgba(255,59,48,.16); border-color:rgba(255,59,48,.35); color:#ffd1ce;}
    button.ghost{ background:transparent; min-width:auto; padding:10px 12px; border-radius:12px; font-weight:900;}
    .smallBtn{ min-width:auto; padding:12px 14px; border-radius:14px; font-weight:900; }
    input[type="number"]{
      width:130px; padding:12px 12px; border-radius:14px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text); font-weight:900; outline:none;
    }
    label{color:var(--muted); font-size:12px; display:flex; flex-direction:column; gap:6px;}
    .hint{color:var(--muted); font-size:12px; line-height:1.4; margin:12px 0 0;}
    .footer{
      padding:10px 14px 14px;
      color:var(--muted); font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div id="err"></div>

    <header>
      <h1>SHOTCLOCK</h1>
      <div class="right">
        <span class="kbd">Space: Start/Stop</span>
        <span class="kbd">R: Blank</span>
        <button class="ghost" id="btnFullscreen">Vollbild</button>
      </div>
    </header>

    <main>
      <div class="displayWrap">
        <div class="time" id="time">24.0</div>
        <div class="sub">
          <span>Status: <strong id="status">Bereit</strong></span>
          <span>Modus: <strong id="modeLabel">24</strong>s</span>
          <span>Sound: <strong id="soundLabel">AN</strong></span>
          <span>Screen: <strong id="wakeLabel">AUS</strong></span>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="row" style="margin-bottom:10px">
            <button id="btnStart" class="primary">Start</button>
            <button id="btnStop">Stop</button>
            <button id="btnBlank" class="danger">Blank</button>
          </div>

          <div class="row">
            <button id="btn24">24</button>
            <button id="btn14">14</button>

            <label style="margin-left:auto">
              Sekunden setzen
              <input id="setSeconds" type="number" min="0" step="0.1" value="24" />
            </label>
            <button id="btnSet" class="smallBtn">Set</button>
          </div>

          <p class="hint">
            Installieren: Chrome → Menü (⋮) → <b>„App installieren“</b> / <b>„Zum Startbildschirm hinzufügen“</b>.
          </p>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between">
            <label>
              Warnung ab (s)
              <input id="warnAt" type="number" min="0" step="0.5" value="5" />
            </label>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnSound" class="smallBtn">Sound AN/AUS</button>
            <button id="btnWake" class="smallBtn">Bildschirm an</button>
            <button id="btnPlus" class="smallBtn">+0.1</button>
            <button id="btnMinus" class="smallBtn">−0.1</button>
          </div>

          <p class="hint">
            Hinweis: Ton & „Bildschirm an“ funktionieren oft erst nach dem ersten Tippen.
          </p>
        </div>
      </div>
    </main>

    <div class="footer">
      <span>Nur Shotclock • 24/14 • Start/Stop • Blank • 0 = Horn</span>
      <span>PWA offline-fähig</span>
    </div>
  </div>

<script>
(() => {
  // On-screen error reporting (mobile friendly)
  const errEl = document.getElementById("err");
  const showErr = (msg) => {
    errEl.style.display = "block";
    errEl.textContent = msg;
  };
  window.addEventListener("error", (e) => showErr("JS-Fehler:\n" + (e?.message || e)));
  window.addEventListener("unhandledrejection", (e) =>
    showErr("Promise-Fehler:\n" + (e?.reason?.message || e?.reason || e))
  );

  // Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try{
        const reg = await navigator.serviceWorker.register("./sw.js");
        if (reg.waiting) reg.waiting.postMessage({ type: "SKIP_WAITING" });
      } catch(e){
        showErr("Service Worker konnte nicht registriert werden:\n" + (e?.message || e));
      }
    });
  }

  // Elements
  const elTime = document.getElementById('time');
  const elStatus = document.getElementById('status');
  const elMode = document.getElementById('modeLabel');
  const elSoundLabel = document.getElementById('soundLabel');
  const elWakeLabel = document.getElementById('wakeLabel');

  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnBlank = document.getElementById('btnBlank');
  const btn24 = document.getElementById('btn24');
  const btn14 = document.getElementById('btn14');
  const btnSet = document.getElementById('btnSet');

  const btnSound = document.getElementById('btnSound');
  const btnWake = document.getElementById('btnWake');
  const btnPlus = document.getElementById('btnPlus');
  const btnMinus = document.getElementById('btnMinus');
  const btnFullscreen = document.getElementById('btnFullscreen');

  const inpSet = document.getElementById('setSeconds');
  const inpWarn = document.getElementById('warnAt');

  // State
  let defaultMode = 24;
  let remaining = defaultMode;
  let running = false;
  let isBlank = false;

  let lastTs = null;
  let rafId = null;

  // Sound
  let soundOn = true;
  let audioCtx = null;

  // Wake Lock
  let wakeLock = null;
  let wakeOn = false;

  function formatTime(sec){
    const s = Math.max(0, sec);
    return (Math.round(s * 10) / 10).toFixed(1);
  }

  function setStatus(txt){ elStatus.textContent = txt; }

  function render(){
    if (isBlank){
      elTime.textContent = "";
      elTime.classList.remove('danger');
    } else {
      elTime.textContent = formatTime(remaining);
      const warnAt = Number(inpWarn.value || 0);
      elTime.classList.toggle('danger', remaining <= warnAt && running);
    }
    elSoundLabel.textContent = soundOn ? "AN" : "AUS";
    elWakeLabel.textContent = wakeOn ? "AN" : "AUS";
  }

  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }

  // Horn: "klassisch, sauber" (weniger kratzig)
  function beep(){
    if (!soundOn) return;

    try{
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;

      const master = ctx.createGain();
      master.gain.setValueAtTime(0.0001, now);
      master.connect(ctx.destination);

      const dur = 0.75;
      master.gain.exponentialRampToValueAtTime(0.55, now + 0.015); // attack
      master.gain.setValueAtTime(0.55, now + dur - 0.10);          // hold
      master.gain.exponentialRampToValueAtTime(0.0001, now + dur); // release

      const o1 = ctx.createOscillator();
      const o2 = ctx.createOscillator();
      o1.type = "triangle";
      o2.type = "sine";

      o1.detune.setValueAtTime(-4, now);
      o2.detune.setValueAtTime(+4, now);

      o1.frequency.setValueAtTime(740, now);
      o2.frequency.setValueAtTime(740, now);
      o1.frequency.exponentialRampToValueAtTime(640, now + dur);
      o2.frequency.exponentialRampToValueAtTime(640, now + dur);

      const bp = ctx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(900, now);
      bp.Q.setValueAtTime(0.8, now);

      const g1 = ctx.createGain();
      const g2 = ctx.createGain();
      g1
